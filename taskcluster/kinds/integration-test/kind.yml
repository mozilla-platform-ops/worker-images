# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
---
loader: taskgraph.loader.transform:loader

transforms:
  - mozilla_taskgraph.transforms.replicate
  - worker_images_taskgraph.transforms.filter_by_worker_type
  - worker_images_taskgraph.transforms.integration_test

tasks:
  gecko:
    description: "Run Gecko integration tests"
    replicate:
      target:
        - gecko.v2.mozilla-central.latest.taskgraph.decision-os-integration
      include-attrs:
        kind:
          - source-test
          - test
          - mochitest
          - browsertime
          - web-platform-tests
      exclude-attrs:
        test_platform:
          - android-hw
          - macosx

  gecko-builds:
    description: "Run Gecko build tasks on alpha worker pools"
    # Filter to only include tasks running on b-win2022 worker type
    filter-worker-types:
      - b-win2022
    replicate:
      target:
        # Use the full decision task to get build tasks (not in os-integration)
        - gecko.v2.mozilla-central.latest.taskgraph.decision
      include-attrs:
        kind:
          - build
      # Exclude builds that don't have alpha pools configured
      exclude-attrs:
        build_platform:
          - android
          - macosx
          - linux

  translations:
    description: "Run translations pipeline integration tests"
    replicate:
      target:
        - translations.v2.translations.latest.taskgraph.decision-run-pipeline
      include-attrs:
        # Corresponds to https://github.com/mozilla/translations/blob/main/taskcluster/kinds/all-pipeline/kind.yml
        stage:
          - all-pipeline
      include-deps:
        # Decision and Action tasks are excluded because we'll be creating the
        # tasks they normally would be.
        # docker-image tasks are excluded because there's no value in rerunning
        # them as part of integration tests.
        - ^(?!(Decision|Action|PR action|build-docker-image|docker-image)).*
