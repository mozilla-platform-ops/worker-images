run-name: OS Integration Tests - ${{ inputs.config }}
name: OS Integration Tests - FXCI

on:
  workflow_dispatch:
    inputs:
      config:
        type: choice
        description: Choose which pool to build
        options:
        - win10-64-2009-alpha
        - win11-64-2009-alpha
        - win11-64-24h2-alpha
        - win11-a64-24h2-tester-alpha
        - win11-a64-24h2-builder-alpha
        - win2022-64-2009-alpha
      image_name:
        type: string
        description: Optional shared image name override
        required: false
  workflow_call:
    inputs:
      config:
        type: string
        description: Config name from config/
        required: true
      image_name:
        type: string
        description: Optional shared image name override
        required: false
    secrets:
      TASKCLUSTER_OS_INT_CLIENT_ID:
        required: true
      TASKCLUSTER_OS_INT_ACCESS_TOKEN:
        required: true

jobs:
  check-access:
    name: "Verify User Access"
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      - name: Load Authorized Users and Check Access
        shell: pwsh
        run: |
          $AUTHORIZED_USERS=$(Get-Content .github/relsre.json | Convertfrom-Json)
          if ($authorized_users -contains "${{ github.actor }}") {
            Write-host "User ${{ github.actor }} is authorized."
          }
          else {
            Write-Host "User ${{ github.actor }} is unauthorized."
            exit 1
          }
  integration-tests:
    needs: check-access
    if: needs.check-access.result == 'success' || needs.check-access.result == 'skipped'
    name: "Trigger Integration Tests"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      - name: Resolve shared image name
        id: resolve-image
        shell: pwsh
        env:
          CONFIG: ${{ inputs.config }}
          IMAGE_NAME_INPUT: ${{ inputs.image_name }}
        run: |
          if ($env:IMAGE_NAME_INPUT) {
            $imageName = $env:IMAGE_NAME_INPUT
          } else {
            Set-PSRepository PSGallery -InstallationPolicy Trusted
            Install-Module powershell-yaml -ErrorAction Stop
            $yaml = ConvertFrom-Yaml (Get-Content "config/$($env:CONFIG).yaml" -Raw)
            $imageName = $yaml.sharedimage.image_name
          }

          if (-not $imageName) {
            Write-Host "::error ::Unable to determine shared image name"
            exit 1
          }

          "image_name=$imageName" >> $env:GITHUB_OUTPUT
          Write-Host "Resolved image name: $imageName"
      - name: Install uv
        uses: astral-sh/setup-uv@803947b9bd8e9f986429fa0c5a41c367cd732b41
      - name: Run OS Integration Tests
        env:
          IMAGE_NAME: ${{ steps.resolve-image.outputs.image_name }}
          TASKCLUSTER_CLIENT_ID: ${{ secrets.TASKCLUSTER_OS_INT_CLIENT_ID }}
          TASKCLUSTER_ACCESS_TOKEN: ${{ secrets.TASKCLUSTER_OS_INT_ACCESS_TOKEN }}
        run: |
          uv run ci/run-os-integration.py "$IMAGE_NAME"
